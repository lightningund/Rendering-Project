#include "textures.hpp"
#include "display.hpp"

#define TEX_SIZE 16
#define PALETTE_BITS 2
#define PALETTE_SIZE (1 << PALETTE_BITS)
#define TEX_PER_ELEM (32 / PALETTE_BITS)
#define TEXEL_MASK (PALETTE_SIZE - 1)
#define NUM_ELEM (TEX_SIZE * TEX_SIZE / TEX_PER_ELEM)

struct Texture {
	color_t palette[PALETTE_SIZE];
	uint32_t tex[NUM_ELEM];
};

static const Texture checker = {
	.palette = {GRAY, WHITE, RED, GREEN},
	.tex = {
		0b00011011000110110001101100011011,
		0b01001110010011100100111001001110,
		0b10110001101100011011000110110001,
		0b11100100111001001110010011100100,
		0b00011011000110110001101100011011,
		0b01001110010011100100111001001110,
		0b10110001101100011011000110110001,
		0b11100100111001001110010011100100,
		0b01001110010011100100111001001110,
		0b10110001101100011011000110110001,
		0b11100100111001001110010011100100,
		0b00011011000110110001101100011011,
		0b01001110010011100100111001001110,
		0b10110001101100011011000110110001,
		0b11100100111001001110010011100100
	}
};

static const color_t pole_col = RGB_TO_DEV(32, 32, 52);
static const color_t winding_col = RGB_TO_DEV(143, 86, 59);

static const Texture bricks = {
	.palette = {pole_col, winding_col, RGB_TO_DEV(224, 0, 224), RGB_TO_DEV(133, 44, 215)},
	.tex = {
		0b01011010101010101010101010100101,
		0b00111110111111111110111111110100,
		0b00111110111111111110111111110100,
		0b01011010101010101010101010100101,
		0b00011111111011111111111110111100,
		0b00011111111011111111111110111100,
		0b01011010101010101010101010100101,
		0b00111110111111111110111111110100,
		0b00111110111111111110111111110100,
		0b01011010101010101010101010100101,
		0b00011111111011111111111110111100,
		0b00011111111011111111111110111100,
		0b01011010101010101010101010100101,
		0b00111110111111111110111111110100,
		0b00111110111111111110111111110100,
		0b01011010101010101010101010100101
	}
};

static const Texture eye = {
	.palette = {pole_col, winding_col, RGB_TO_DEV(53, 180, 215), RGB_TO_DEV(82, 185, 72)},
	.tex = {
		0b01011010101010101010101010100101,
		0b00101010101010101010101010100100,
		0b00101010101010101010101010100100,
		0b01011010101010101010101010100101,
		0b00011010101011111111101010101000,
		0b00011010111110101010111110101000,
		0b01011011101010111110101011100101,
		0b00101110101011101011101010110100,
		0b00101110101011101011101010110100,
		0b01011011101010111110101011100101,
		0b00011010111110101010111110101000,
		0b00011010101011111111101010101000,
		0b01011010101010101010101010100101,
		0b00101010101010101010101010100100,
		0b00101010101010101010101010100100,
		0b01011010101010101010101010100101
	}
};

static const Texture pyramid = {
	.palette = {pole_col, winding_col, RGB_TO_DEV(102, 57, 49), RGB_TO_DEV(255, 250, 140)},
	.tex = {
		0b01011010101010101010101010100101,
		0b00101010101010101010101010100100,
		0b00101011111111111111111111100100,
		0b01011011101010101010101011100101,
		0b00011010111010111110101110101000,
		0b00011010111011101011101110101000,
		0b01011010111011101011101110100101,
		0b00101010101110111110111010100100,
		0b00101010101110101010111010100100,
		0b01011010101011101011101010100101,
		0b00011010101011101011101010101000,
		0b00011010101010111110101010101000,
		0b01011010101010111110101010100101,
		0b00101010101010101010101010100100,
		0b00101010101010101010101010100100,
		0b01011010101010101010101010100101
	}
};

static const Texture riddler = {
	.palette = {pole_col, winding_col, RGB_TO_DEV(49, 102, 63), RGB_TO_DEV(224, 68, 109)},
	.tex = {
		0b01011010101010101010101010100101,
		0b00101010101010101010101010100100,
		0b00101010101010111110101010100100,
		0b01011010101010111110101010100101,
		0b00011010101010101010101010101000,
		0b00011010101010111110101010101000,
		0b01011010101010111010101010100101,
		0b00101010101010111110101010100100,
		0b00101010101010101111101010100100,
		0b01011010101010101011111010100101,
		0b00011010101010101010111010101000,
		0b00011010101110101010111010101000,
		0b01011010101111101011111010100101,
		0b00101010101011111111101010100100,
		0b00101010101010101010101010100100,
		0b01011010101010101010101010100101
	}
};

static const Texture* textures[] = {&bricks, &eye, &pyramid, &riddler};

static color_t get_texel(const Texture* tex, uint8_t x, uint8_t y) {
	unsigned int idx = y * TEX_SIZE + x;
	uint8_t sub_tex = idx % TEX_PER_ELEM;
	idx /= TEX_PER_ELEM;
	uint8_t texel = (tex->tex[idx] >> (sub_tex * PALETTE_BITS)) & TEXEL_MASK;
	return tex->palette[texel];
}

color_t get_tex(uint8_t tex_id, int extent, int sc_y, float t) {
	uint8_t x = (int)(t * TEX_SIZE);
	uint8_t y = ((sc_y - extent) * TEX_SIZE) / ((DISPLAY_SIZE / 2) - extent * 2);
	return get_texel(textures[tex_id], x, y);
}
